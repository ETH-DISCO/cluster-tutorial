Bootstrap: docker
From: nvidia/cuda:12.3.2-base-ubuntu22.04


%files
    ./mnist_classifier.py /mnist_model/mnist_classifier.py
    ./mnist_dataloader.py /mnist_model/mnist_dataloader.py
    ./train.py /mnist_model/train.py
    # Copy all files from mnist-data to /mnist_model/mnist-data
    ./mnist-data /mnist_model/mnist-data

%post
    # Set timezone and locale
    TZ=Europe/Berlin
    ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone
    echo "LC_ALL=en_US.UTF-8" >> /etc/environment

    # Update and install system packages
    apt-get update -y
    DEBIAN_FRONTEND=noninteractive apt-get install -y \
        software-properties-common \
        curl

    # Get Python 3.10
    # Add PPA to install Python 3.10
    add-apt-repository ppa:deadsnakes/ppa -y
    add-apt-repository ppa:ubuntu-toolchain-r/test -y
    apt-get update -y
    DEBIAN_FRONTEND=noninteractive apt-get install -y \
        python3.10

    # Find the path to Python 3.10 and set it as the default python3
    PYTHON310_PATH=$(which python3.10)
    if [ -z "$PYTHON310_PATH" ]; then
        echo "Python 3.10 not found"
        exit 1
    fi
    update-alternatives --install /usr/bin/python3 python3 $PYTHON310_PATH 1
    update-alternatives --set python3 $PYTHON310_PATH

    # Ensure pip is installed for Python 3.10
    curl -sS https://bootstrap.pypa.io/get-pip.py | python3.10
    python3 --version
    python3 -m pip --version
    python3 -m pip install --upgrade pip
    python3 -m pip install --upgrade setuptools

    # Install PyTorch and other required packages
    python3 -m pip install torch --index-url https://download.pytorch.org/whl/cu118

    export SKLEARN_ALLOW_DEPRECATED_SKLEARN_PACKAGE_INSTALL=True
    python3 -m pip install \
        numpy>=2.0.0

    # Clean up
    apt-get clean
    rm -rf /var/lib/apt/lists/*

%environment
    export SKLEARN_ALLOW_DEPRECATED_SKLEARN_PACKAGE_INSTALL=True

%runscript
    cd /mnist_model
    python3 /mnist_model/train.py
